<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expense Tracker</title>
  <link rel="icon" type="image/png" href="iconn.png"/>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    body {
       background:
    linear-gradient(
      rgba(255, 255, 255, 0.2),
      rgba(255, 255, 255, 0.2)
    ),
       url("bg.jpg");  
       background-color: #feda6d; 
  background-size: cover;              
  background-repeat: no-repeat;        
  background-position: center;
  background-attachment: fixed;        
  


    }

    .balance-safe {
      color: #176641; 
      font-weight: bold;
      font-size: 1.4rem;
      font-style: oblique;
    }

    .balance-warning {
      color: #ae2b38; 
      font-weight: bold;
      font-size: 1.4rem;
    }
   .monthly {
    font-family: fantasy;
    font-variation-settings: inherit;

   }
   .my-btn {
  background-color: #e2c99b;   
  color: rgb(17, 16, 16);
  border: 2px solid black;
}

.my-btn:hover {
  background-color: #aa9164;
  color: rgb(14, 13, 13);
}
.my-btn2{
  background-color: #e2c99b;
  color: black;
  border: 2px solid black;
}
.my-btn2:hover {
  background-color: #aa9164;
  color: rgb(14, 13, 13);
}
.titl{
  font-family:'brush script mt';
  font-size: 40px;
}
.lim{
  font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
}
.move-down {
  margin-top: 140px;
}


  </style>
</head>

<body>

  <div class="container move-down" style="max-width: 500px;">
    <div class="card p-3 shadow rounded" style="background-color: #957d51;">

      <h3 class="mb-4 text-center titl">Expense Tracker</h3>

      <!-- Set limits -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label monthly">Monthly Limit</label>
          <input type="number" id="limit" class="form-control" placeholder="e.g. 5000">
        </div>
        <div class="col-md-6">
          <label class="form-label monthly">Safe Limit</label>
          <input type="number" id="safeLimit" class="form-control" placeholder="e.g. 1000">
        </div>
      </div>

      <button id="setLimit" class="btn my-btn w-100 mb-3 lim">
        Set Limit
      </button>

      <h5 class="text-center mb-4 monthly">
        Remaining Balance:
        <span id="balance" class="balance-safe">₹0</span>
      </h5>

      <hr>

      <!-- Add expense -->
      <div class="row mb-3">
        <div class="col-md-8">
          <input
            type="text"
            id="desc"
            class="form-control"
            placeholder="Expense description"
          >
        </div>
        <div class="col-md-4">
          <input
            type="number"
            id="amount"
            class="form-control"
            placeholder="Amount"
          >
        </div>
      </div>

      <button id="addExpense" class="btn my-btn2 w-100 lim">
        Add Expense
      </button>

      <hr>

      <!-- Expense list -->
      <ul id="expenseList" class="list-group"></ul>

    </div>
  </div>
 <script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabaseUrl = "https://rmpzizeeemtcmqueqhwn.supabase.co";
  const supabaseAnonKey = "sb_publishable_-8LU8sAFiX08MW8TugBmqg_7NUhHcv0";

  const supabase = createClient(supabaseUrl, supabaseAnonKey);
  window.supabase = supabase;

  console.log("Supabase client created:", supabase);
</script>



  <script>
  
  let supabase;

  $(function () {
    // 1️⃣ INITIALIZE (MUST COME FIRST)
    supabase = window.supabase;
    const now = new Date();
const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;


    let totalLimit = 0;
    let remaining = 0;
    let safeLimit = 0;

    // 2️⃣ FUNCTIONS (READ)

    async function loadLimits() {
  const { data, error } = await supabase
    .from("settings")
    .select("*")
    .eq("month", currentMonth)
    .maybeSingle();


  if (error && error.code !== "PGRST116") {
    console.error("Failed to load limits", error);
    return false;
  }

  if (data) {
    totalLimit = data.monthly_limit;
    safeLimit = data.safe_limit;
    remaining = totalLimit;

    $("#limit").val(totalLimit);
    $("#safeLimit").val(safeLimit);

    updateBalance();
    return true;   // ✅ limits exist
  }

  return false;    // ❌ no limits for this month
}


    async function loadExpenses() {
      const { data, error } = await supabase
        .from("expenses")
        .select("*")
        .eq("month", currentMonth)
        .order("date", { ascending: true });

      if (error) {
        console.error("Failed to load expenses", error);
        return;
      }

      $("#expenseList").empty();

      data.forEach(exp => {
        remaining -= exp.amount;

        $("#expenseList").append(`
          <li class="list-group-item d-flex justify-content-between">
            <span>${exp.description}</span>
            <span class="text-danger">-₹${exp.amount}</span>
          </li>
        `);
      });

      updateBalance();
    }

    function updateBalance() {
      $("#balance").text(`₹${remaining}`);

      if (remaining < safeLimit) {
        $("#balance")
          .removeClass("balance-safe")
          .addClass("balance-warning");
      } else {
        $("#balance")
          .removeClass("balance-warning")
          .addClass("balance-safe");
      }
    }

    // 3️⃣ WRITE HANDLERS

    $("#setLimit").click(async function () {
      totalLimit = Number($("#limit").val());
      safeLimit = Number($("#safeLimit").val());

      if (totalLimit <= 0 || safeLimit < 0) {
        alert("Please enter valid limits");
        return;
      }

      const { error } = await supabase
        .from("settings")
        .upsert({
          month: currentMonth,
          monthly_limit: totalLimit,
          safe_limit: safeLimit
        });

      if (error) {
        console.error(error);
        alert("Failed to save limits");
        return;
      }

      remaining = totalLimit;
      updateBalance();
      $("#expenseList").empty();
    });

    $("#addExpense").click(async function () {
      const desc = $("#desc").val().trim();
      const amount = Number($("#amount").val());

      if (!desc || amount <= 0) {
        alert("Enter valid expense details");
        return;
      }

      const today = new Date().toISOString().split("T")[0];

      const { error } = await supabase
        .from("expenses")
        .insert({
          description: desc,
          amount,
          date: today,
          month: currentMonth
        });

      if (error) {
        console.error(error);
        alert("Failed to save expense");
        return;
      }

      remaining -= amount;
      updateBalance();

      $("#expenseList").append(`
        <li class="list-group-item d-flex justify-content-between">
          <span>${desc}</span>
          <span class="text-danger">-₹${amount}</span>
        </li>
      `);

      $("#desc").val("");
      $("#amount").val("");
    });

   (async function init() {
  const hasLimits = await loadLimits();

  if (hasLimits) {
    await loadExpenses();
  }
})();

});
</script>



</body>


</html>
